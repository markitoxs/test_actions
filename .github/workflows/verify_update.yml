name: Verify VERSION file

on:
  pull_request:
    branches: [ master ]

jobs:
  check_that_version_file_is_updated:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1

    # compare what files have changed 
    - name: Make sure VERSION is changed if terraform files included
      run: |
        git fetch -q origin ${{ github.base_ref }}
        list=$(git diff origin/${{ github.base_ref }} --name-only)
        TF_CHANGED=$(echo $list | grep .tf | wc -l)
        VERSION_CHANGED=$(echo $list | grep VERSION | wc -l)
        echo $TF_CHANGED
        echo $VERSION_CHANGED
        [[ $TF_CHANGED != "0" ]] && 
        [[ $VERSION_CHANGED == "0" ]] && 
        echo "[ERROR] *.tf files modified but VERSION didnt change" &&
        exit 1

        exit 0
